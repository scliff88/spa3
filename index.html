<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Solar Pre-Approval Application</title>
  <style>
    :root{
      --brand:#667eea; --brand2:#764ba2; --ink:#333; --muted:#666; --line:#e6e6e6;
      --ok:#16a34a; --warn:#b45309; --err:#b91c1c; --soft:#f8f9ff;
    }
    *{box-sizing:border-box}
    body{
      font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;
      background: linear-gradient(135deg, var(--brand) 0%, var(--brand2) 100%);
      margin:0; padding:24px; display:flex; align-items:center; justify-content:center; min-height:100vh;
      color:var(--ink);
    }
    .container{
      background:#fff; border-radius:14px; box-shadow:0 14px 28px rgba(0,0,0,.12);
      width:100%; max-width:860px; padding:32px;
    }
    h1{margin:0 0 6px; font-size:1.9rem;}
    .subtitle{color:#555; margin:0 0 24px; font-size:1.05rem}
    .section{margin-top:28px}
    .section-header{color:var(--brand); border-bottom:2px solid var(--brand); padding-bottom:8px; margin-bottom:14px}
    label{font-weight:600; color:#555; display:block; margin:10px 0 6px}
    input[type="text"], input[type="number"]{
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid #cbd5e1; font-size:1rem;
      transition:border-color .2s ease, box-shadow .2s ease;
    }
    input[type="text"]:focus, input[type="number"]:focus{outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(102,126,234,.15)}
    .help-text{font-size:.92rem; color:#6b7280; margin:4px 0 0; font-style:italic}
    .error{color:var(--err); font-size:.95rem; margin-top:6px}
    .hidden{display:none}
    .alert{
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      padding:18px; border-radius:10px; margin:6px 0 14px;
    }
    .property-info{display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px; margin-top:10px}
    .backstop{background:#fff7e6; border-left:5px solid #ffbf47; padding:14px; border-radius:8px; color:#7a5400; margin:14px 0}
    .sub-options{background:var(--soft); border:1px dashed #dbeafe; padding:14px; border-radius:10px; margin-top:10px}
    .inline{display:flex; align-items:center; gap:8px}
    input[type="checkbox"], input[type="radio"]{transform:scale(1.2); margin-right:6px}
    .note{font-size:.9rem; color:#444; margin:6px 0 0}
    .limit-card{background:#f1f5ff; border:1px solid #c7d2fe; padding:12px; border-radius:10px; margin-top:10px}
    .limit-card strong{color:#1e40af}
    .total{background:linear-gradient(135deg,#4facfe 0%, #00f2fe 100%); color:#fff; text-align:center; padding:16px; border-radius:10px; font-weight:700; margin:18px 0}
    .outcome{padding:14px; border-radius:10px; margin-top:10px}
    .outcome.ok{background:#ecfdf5; border:1px solid #a7f3d0; color:#065f46}
    .outcome.warn{background:#fff7ed; border:1px solid #fed7aa; color:#7c2d12}
    .btn{
      appearance:none; border:0; background:linear-gradient(135deg, var(--brand) 0%, var(--brand2) 100%); color:#fff;
      padding:12px 16px; border-radius:10px; font-weight:700; cursor:pointer; box-shadow:0 8px 18px rgba(0,0,0,.12);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .export-only-note{
      background:#e0f2fe; border:1px solid #7dd3fc; padding:12px; border-radius:8px; color:#0c4a6e; margin:10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Solar Pre-Approval Application</h1>
    <p class="subtitle">Simple demo showing DC vs AC battery, EV as load, and export-increase-only flow.</p>

    <!-- 1) NMI -->
    <div class="section">
      <label for="nmi">Enter your NMI to search for your property</label>
      <input id="nmi" type="text" placeholder="Enter your 11-character NMI" />
      <p class="help-text">You'll find this on your electricity bill.</p>
      <p id="nmiError" class="error hidden">We couldn't match that NMI. Check the number and try again.</p>
    </div>

    <!-- 2) Property card -->
    <div id="propertyArea" class="hidden">
      <div class="alert">
        <h3>✅ Property Found</h3>
        <div id="propAddress">Demo Property, VIC</div>
        <div class="property-info">
          <div><strong>Current Solar Export Approval</strong><div id="propExport">–</div></div>
          <div><strong>Approval Valid Until</strong><div id="propExpiry">–</div></div>
          <div><strong>Connection Type</strong><div id="propPhase">–</div></div>
        </div>
      </div>
    </div>

    <!-- 3) Installation details -->
    <div id="installArea" class="section hidden">
      <h2 class="section-header">Installation Details</h2>

      <label for="approvedAC">Current System Size (kW)</label>
      <input id="approvedAC" type="text" disabled style="background:#f3f4f6"/>
      <p class="help-text">Current approved AC capacity on record.</p>

      <div class="backstop">
        <strong>Victoria's Emergency Backstop</strong><br>
        0–30 kVA: internet device required<br>
        31–200 kVA: internet or GMM<br>
        No internet: zero export
      </div>

      <label>What are you installing today?</label>
      <div class="inline"><input id="chkInverter" type="checkbox"> <span>Solar inverters</span></div>
      <div id="inverterBox" class="sub-options hidden">
        <div class="inline"><input id="invAdd" type="checkbox"><span>Adding new inverter(s)</span></div>
        <div id="invAddBox" class="sub-options hidden">
          <label>Additional inverter AC capacity (kW)</label>
          <input id="invAddKw" type="number" min="0" step="0.1">
        </div>

        <div class="inline"><input id="invReplace" type="checkbox"><span>Replacing inverter(s)</span></div>
        <div id="invReplaceBox" class="sub-options hidden">
          <label>Removed AC (kW)</label>
          <input id="invRemoveKw" type="number" min="0" step="0.1">
          <label>Installed AC (kW)</label>
          <input id="invNewKw" type="number" min="0" step="0.1">
          <p class="help-text">Warranty or like-for-like swaps keep the same AC capacity.</p>
        </div>
      </div>

      <div class="inline" style="margin-top:8px"><input id="chkBattery" type="checkbox"><span>Battery storage</span></div>
      <div id="batteryBox" class="sub-options hidden">
        <label>What kind of battery?</label>
        <div class="inline"><input type="radio" name="batType" id="batDC" value="dc"><span>DC-coupled (behind existing inverter)</span></div>
        <div class="inline"><input type="radio" name="batType" id="batAC" value="ac"><span>AC-coupled (has its own inverter)</span></div>

        <div id="batACBox" class="sub-options hidden">
          <div class="inline"><input id="batAdd" type="checkbox"><span>Adding AC battery</span></div>
          <div id="batAddBox" class="sub-options hidden">
            <label>Battery AC capacity (kW)</label>
            <input id="batAddKw" type="number" min="0" step="0.1">
          </div>

          <div class="inline"><input id="batReplace" type="checkbox"><span>Replacing AC battery</span></div>
          <div id="batReplaceBox" class="sub-options hidden">
            <label>Removed AC (kW)</label>
            <input id="batRemoveKw" type="number" min="0" step="0.1">
            <label>Installed AC (kW)</label>
            <input id="batNewKw" type="number" min="0" step="0.1">
          </div>
        </div>

        <p id="batDCNote" class="note hidden">DC batteries don't add to AC capacity.</p>
      </div>

      <div class="inline" style="margin-top:8px"><input id="chkEV" type="checkbox"><span>EV charger</span></div>
      <div id="evBox" class="sub-options hidden">
        <div class="inline"><input id="evAdd" type="checkbox"><span>Adding charger</span></div>
        <div id="evAddBox" class="sub-options hidden">
          <label>Charger size (kW)</label>
          <input id="evAddKw" type="number" min="0" step="0.1">
        </div>

        <div class="inline"><input id="evReplace" type="checkbox"><span>Replacing charger</span></div>
        <div id="evReplaceBox" class="sub-options hidden">
          <label>Removed (kW)</label>
          <input id="evRemoveKw" type="number" min="0" step="0.1">
          <label>Installed (kW)</label>
          <input id="evNewKw" type="number" min="0" step="0.1">
        </div>
      </div>

      <div class="inline" style="margin-top:8px"><input id="chkExportOnly" type="checkbox"><span>Export increase only</span></div>
      <div id="exportOnlyNote" class="export-only-note hidden">If you're only requesting additional export, please proceed to the export settings section below.</div>

      <div class="total">New Total Proposed AC Capacity: <span id="totalCapacity2">0.0</span> kW</div>
    </div>

    <!-- 4) Export -->
    <div id="exportArea" class="section hidden">
      <h2 class="section-header">Current Export Limit and New Request</h2>
      <label>Current export (kW)</label>
      <input id="currentExport" type="text" disabled style="background:#f3f4f6">
      <label for="reqExport">Requested export limit (kW)</label>
      <input id="reqExport" type="number" min="0" step="0.1">
      <p id="exportUpTo" class="help-text hidden"></p>
      <p id="exportErr" class="error hidden">Requested limit cannot exceed the New Total Proposed AC Capacity.</p>

      <div id="outcome" class="outcome hidden"></div>
      <div style="margin-top:12px"><button id="cta" class="btn" disabled>Check my request</button></div>
    </div>
  </div>

  <script>
    let baseAC = 0, proposedAC = 0, phase = "Single Phase";
    let exportMaxByPhase = 5, systemMaxByPhase = 10;
    const byId = id => document.getElementById(id);

    // NMI lookup demo
    byId('nmi').addEventListener('input', e => {
      const nmi = e.target.value.trim();
      if(nmi.length === 11){
        baseAC = 5.0;
        byId('approvedAC').value = baseAC.toFixed(1)+" kW";
        byId('propExport').textContent = "5.0 kW";
        byId('propExpiry').textContent = "31/12/2026";
        byId('propPhase').textContent = phase;
        byId('currentExport').value = "5.0";
        ['propertyArea','installArea','exportArea','exportUpTo'].forEach(x=>byId(x).classList.remove('hidden'));
        byId('nmiError').classList.add('hidden');
        calcAndRender();
      } else {
        byId('nmiError').classList.toggle('hidden', nmi.length === 0);
        ['propertyArea','installArea','exportArea'].forEach(x=>byId(x).classList.add('hidden'));
      }
    });

    // Show/hide helpers
    function bindToggle(chk, box){
      byId(chk).addEventListener('change', ()=>{
        if(box!=='noop'){ byId(box).classList.toggle('hidden', !byId(chk).checked); }
        calcAndRender();
      });
    }
    bindToggle('chkInverter','inverterBox');
    bindToggle('invAdd','invAddBox');
    bindToggle('invReplace','invReplaceBox');
    bindToggle('chkBattery','batteryBox');
    bindToggle('batAdd','batAddBox');
    bindToggle('batReplace','batReplaceBox');
    bindToggle('chkEV','evBox');
    bindToggle('evAdd','evAddBox');
    bindToggle('evReplace','evReplaceBox');
    bindToggle('chkExportOnly','noop');

    // Battery type radios
    function showBatType(){
      byId('batACBox').classList.toggle('hidden', !byId('batAC').checked);
      byId('batDCNote').classList.toggle('hidden', !byId('batDC').checked);
      calcAndRender();
    }
    ['batAC','batDC'].forEach(id=>byId(id).addEventListener('change',showBatType));

    // Inputs trigger recalculation
    ['invAddKw','invRemoveKw','invNewKw','batAddKw','batRemoveKw','batNewKw','evAddKw','evRemoveKw','evNewKw','reqExport']
      .forEach(id => byId(id).addEventListener('input', calcAndRender));

    // Calculation
    function calcApprovedCapacity(){
      let total = baseAC;

      if(byId('chkInverter').checked){
        if(byId('invAdd').checked){ total += +byId('invAddKw').value||0; }
        if(byId('invReplace').checked){
          total = total - (+byId('invRemoveKw').value||0) + (+byId('invNewKw').value||0);
        }
      }

      if(byId('chkBattery').checked && byId('batAC').checked){
        if(byId('batAdd').checked){ total += +byId('batAddKw').value||0; }
        if(byId('batReplace').checked){
          total = total - (+byId('batRemoveKw').value||0) + (+byId('batNewKw').value||0);
        }
      }

      return Math.max(0,total);
    }

    function calcAndRender(){
      proposedAC = calcApprovedCapacity();
      byId('totalCapacity2').textContent = proposedAC.toFixed(1);
      byId('exportUpTo').textContent = `You can request up to ${proposedAC.toFixed(1)} kW.`;
      byId('cta').disabled = byId('nmi').value.trim().length !== 11;
    }
  </script>
</body>
</html>
