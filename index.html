<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>New Solar Pre-Approval Application</title>
  <style>
    :root{
      --brand:#667eea; --brand2:#764ba2; --ink:#333; --muted:#666; --line:#e6e6e6;
      --ok:#16a34a; --warn:#b45309; --err:#b91c1c; --soft:#f8f9ff;
    }
    *{box-sizing:border-box}
    body{
      font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;
      background: linear-gradient(135deg, var(--brand) 0%, var(--brand2) 100%);
      margin:0; padding:24px; display:flex; align-items:center; justify-content:center; min-height:100vh;
      color:var(--ink);
    }
    .container{
      background:#fff; border-radius:14px; box-shadow:0 14px 28px rgba(0,0,0,.12);
      width:100%; max-width:860px; padding:32px;
    }
    h1{margin:0 0 6px; font-size:1.9rem;}
    .subtitle{color:#555; margin:0 0 24px; font-size:1.05rem}
    .section{margin-top:28px}
    .section-header{color:var(--brand); border-bottom:2px solid var(--brand); padding-bottom:8px; margin-bottom:14px}
    label{font-weight:600; color:#555; display:block; margin:10px 0 6px}
    input[type="text"], input[type="number"]{
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid #cbd5e1; font-size:1rem;
      transition:border-color .2s ease, box-shadow .2s ease;
    }
    input[type="text"]:focus, input[type="number"]:focus{outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(102,126,234,.15)}
    .help-text{font-size:.92rem; color:#6b7280; margin:4px 0 0; font-style:italic}
    .error{color:var(--err); font-size:.95rem; margin-top:6px}
    .hidden{display:none}
    .alert{
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      padding:18px; border-radius:10px; margin:6px 0 14px;
    }
    .property-info{display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px; margin-top:10px}
    .backstop{background:#fff7e6; border-left:5px solid #ffbf47; padding:14px; border-radius:8px; color:#7a5400; margin:14px 0}
    .sub-options{background:var(--soft); border:1px dashed #dbeafe; padding:14px; border-radius:10px; margin-top:10px}
    .inline{display:flex; align-items:center; gap:8px}
    input[type="checkbox"], input[type="radio"]{transform:scale(1.2); margin-right:6px}
    .note{font-size:.9rem; color:#444; margin:6px 0 0}
    .limit-card{background:#f1f5ff; border:1px solid #c7d2fe; padding:12px; border-radius:10px; margin-top:10px}
    .limit-card strong{color:#1e40af}
    .total{background:linear-gradient(135deg,#4facfe 0%, #00f2fe 100%); color:#fff; text-align:center; padding:16px; border-radius:10px; font-weight:700; margin:18px 0}
    .outcome{padding:14px; border-radius:10px; margin-top:10px}
    .outcome.ok{background:#ecfdf5; border:1px solid #a7f3d0; color:#065f46}
    .outcome.warn{background:#fff7ed; border:1px solid #fed7aa; color:#7c2d12}
    .btn{
      appearance:none; border:0; background:linear-gradient(135deg, var(--brand) 0%, var(--brand2) 100%); color:#fff;
      padding:12px 16px; border-radius:10px; font-weight:700; cursor:pointer; box-shadow:0 8px 18px rgba(0,0,0,.12);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .export-only-note{
      background:#e0f2fe; border:1px solid #7dd3fc; padding:12px; border-radius:8px; color:#0c4a6e; margin:10px 0;
    }
    .component-box{
      background:var(--soft); border:1px solid #dbeafe; padding:16px; border-radius:10px; margin-top:10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>New Solar Pre-Approval Application</h1>
    <p class="subtitle">Apply for pre-approval for your new solar installation including inverters, batteries, and EV chargers.</p>

    <!-- 1) NMI -->
    <div class="section">
      <label for="nmi">Enter your NMI to search for your property</label>
      <input id="nmi" type="text" placeholder="Enter your 11-character NMI" />
      <p class="help-text">You'll find this on your electricity bill.</p>
      <p id="nmiError" class="error hidden">We couldn't match that NMI. Check the number and try again.</p>
    </div>

    <!-- 2) Property card -->
    <div id="propertyArea" class="hidden">
      <div class="alert">
        <h3>✅ Property Found</h3>
        <div id="propAddress">Demo Property, VIC</div>
        <div class="property-info">
          <div><strong>Current Solar Export Approval</strong><div id="propExport">No existing system</div></div>
          <div><strong>Connection Type</strong><div id="propPhase">Single Phase</div></div>
        </div>
      </div>
    </div>

    <!-- 3) Installation details -->
    <div id="installArea" class="section hidden">
      <h2 class="section-header">New Installation Details</h2>

      <div class="backstop">
        <strong>Victoria's Emergency Backstop</strong><br>
        0–30 kVA: internet device required<br>
        31–200 kVA: internet or GMM<br>
        No internet: zero export
      </div>

      <label>What are you installing?</label>
      
      <!-- Solar Inverters -->
      <div class="inline"><input id="chkInverter" type="checkbox"> <span>Solar inverters</span></div>
      <div id="inverterBox" class="component-box hidden">
        <label for="inverterKw">Solar inverter AC capacity (kW)</label>
        <input id="inverterKw" type="number" min="0" step="0.1" placeholder="e.g. 5.0">
        <p class="help-text">Total AC capacity of all solar inverters being installed.</p>
      </div>

      <!-- Battery -->
      <div class="inline" style="margin-top:8px"><input id="chkBattery" type="checkbox"><span>Battery storage</span></div>
      <div id="batteryBox" class="component-box hidden">
        <label>What kind of battery?</label>
        <div class="inline"><input type="radio" name="batType" id="batDC" value="dc"><span>DC-coupled (behind solar inverter)</span></div>
        <div class="inline"><input type="radio" name="batType" id="batAC" value="ac"><span>AC-coupled (has its own inverter)</span></div>

        <div id="batACBox" class="sub-options hidden">
          <label for="batteryKw">Battery AC capacity (kW)</label>
          <input id="batteryKw" type="number" min="0" step="0.1" placeholder="e.g. 5.0">
          <p class="help-text">AC capacity of the battery inverter.</p>
        </div>

        <p id="batDCNote" class="note hidden">DC batteries don't add to total AC capacity.</p>
      </div>

      <!-- EV Charger -->
      <div class="inline" style="margin-top:8px"><input id="chkEV" type="checkbox"><span>EV charger</span></div>
      <div id="evBox" class="component-box hidden">
        <label for="evKw">EV charger capacity (kW)</label>
        <input id="evKw" type="number" min="0" step="0.1" placeholder="e.g. 7.4">
        <p class="help-text">Maximum charging capacity of the EV charger.</p>
      </div>

      <!-- Export Increase Only -->
      <div class="inline" style="margin-top:8px"><input id="chkExportOnly" type="checkbox"><span>Export increase only</span></div>
      <div id="exportOnlyNote" class="export-only-note hidden">
        If you're only requesting additional export capacity without installing new equipment, check this box and proceed to the export settings section below.
      </div>

      <div class="total">Total Proposed AC Capacity: <span id="totalCapacity">0.0</span> kW</div>
    </div>

    <!-- 4) Export -->
    <div id="exportArea" class="section hidden">
      <h2 class="section-header">Export Limit Request</h2>
      <label for="reqExport">Requested export limit (kW)</label>
      <input id="reqExport" type="number" min="0" step="0.1" placeholder="e.g. 5.0">
      <p id="exportUpTo" class="help-text">You can request up to the total AC capacity of your system.</p>
      <p id="exportErr" class="error hidden">Requested limit cannot exceed the Total Proposed AC Capacity.</p>

      <div id="outcome" class="outcome hidden"></div>
      <div style="margin-top:12px"><button id="cta" class="btn" disabled>Submit Pre-Approval Request</button></div>
    </div>
  </div>

  <script>
    let totalAC = 0;
    const byId = id => document.getElementById(id);

    // NMI lookup demo
    byId('nmi').addEventListener('input', e => {
      const nmi = e.target.value.trim();
      if(nmi.length === 11){
        ['propertyArea','installArea','exportArea'].forEach(x=>byId(x).classList.remove('hidden'));
        byId('nmiError').classList.add('hidden');
        calcAndRender();
      } else {
        byId('nmiError').classList.toggle('hidden', nmi.length === 0);
        ['propertyArea','installArea','exportArea'].forEach(x=>byId(x).classList.add('hidden'));
      }
    });

    // Show/hide component boxes
    function bindToggle(chk, box){
      byId(chk).addEventListener('change', ()=>{
        if(box !== 'noop'){ 
          byId(box).classList.toggle('hidden', !byId(chk).checked); 
        }
        calcAndRender();
      });
    }
    
    bindToggle('chkInverter','inverterBox');
    bindToggle('chkBattery','batteryBox');
    bindToggle('chkEV','evBox');
    bindToggle('chkExportOnly','exportOnlyNote');

    // Battery type radios
    function showBatType(){
      const isAC = byId('batAC').checked;
      const isDC = byId('batDC').checked;
      
      byId('batACBox').classList.toggle('hidden', !isAC);
      byId('batDCNote').classList.toggle('hidden', !isDC);
      calcAndRender();
    }
    ['batAC','batDC'].forEach(id=>byId(id).addEventListener('change',showBatType));

    // Input changes trigger recalculation
    ['inverterKw','batteryKw','evKw','reqExport'].forEach(id => 
      byId(id).addEventListener('input', calcAndRender)
    );

    // Calculate total AC capacity
    function calcTotalCapacity(){
      let total = 0;

      // Solar inverters
      if(byId('chkInverter').checked){
        total += +byId('inverterKw').value || 0;
      }

      // AC-coupled battery
      if(byId('chkBattery').checked && byId('batAC').checked){
        total += +byId('batteryKw').value || 0;
      }

      // EV charger (counted as load, not generation, but included in AC capacity)
      if(byId('chkEV').checked){
        total += +byId('evKw').value || 0;
      }

      return Math.max(0, total);
    }

    function calcAndRender(){
      totalAC = calcTotalCapacity();
      byId('totalCapacity').textContent = totalAC.toFixed(1);
      byId('exportUpTo').textContent = `You can request up to ${totalAC.toFixed(1)} kW export limit.`;
      
      // Enable/disable submit button
      const nmiValid = byId('nmi').value.trim().length === 11;
      const hasComponents = byId('chkInverter').checked || byId('chkBattery').checked || byId('chkEV').checked || byId('chkExportOnly').checked;
      byId('cta').disabled = !nmiValid || !hasComponents;

      // Validate export request
      const reqExport = +byId('reqExport').value || 0;
      if(reqExport > totalAC && totalAC > 0){
        byId('exportErr').classList.remove('hidden');
        byId('outcome').classList.add('hidden');
      } else {
        byId('exportErr').classList.add('hidden');
        
        if(reqExport > 0 && totalAC > 0){
          byId('outcome').className = 'outcome ok';
          byId('outcome').innerHTML = `<strong>✅ Request looks good!</strong><br>Your request for ${reqExport}kW export from ${totalAC}kW total capacity appears to meet requirements.`;
          byId('outcome').classList.remove('hidden');
        } else {
          byId('outcome').classList.add('hidden');
        }
      }
    }

    // Submit button click
    byId('cta').addEventListener('click', () => {
      alert('Pre-approval request submitted! You will receive confirmation via email within 2-3 business days.');
    });
  </script>
</body>
</html>
